# Clonk X Factory

Clonk X Factory is an autonomous X (Twitter) bot that turns tweets into deployed web applications. When someone mentions **@clonkbot** with the word "build" and an app idea, the bot generates a complete React + TypeScript + Vite application using Claude (Sonnet 4), deploys it to Vercel, pushes the source code to a public GitHub repository, and replies to the original tweet with both links.

## Architecture

```
 User tweets "@clonkbot build a pomodoro timer"
                     |
                     v
         +---------------------+
         |   X API v2 Polling  |  (every 2 minutes, Bearer token)
         +---------------------+
                     |
                     v
         +---------------------+
         |   Mention Filtering |  requires "build" keyword
         +---------------------+
                     |
                     v
  +------------------------------------------+
  |          Pipeline (background)           |
  |                                          |
  |  1. Claude Sonnet 4 -- generate app      |
  |  2. Vercel API -- deploy to production   |
  |  3. GitHub API -- create public repo     |
  |  4. X API (OAuth 1.0a) -- reply tweet    |
  +------------------------------------------+
                     |
                     v
  Bot replies: "App live: https://...vercel.app
                Contribute: https://github.com/clonkbot/..."
```

### Infrastructure

| Component | Details |
|---|---|
| **Bot hosting** | Railway (auto-deploys on push to `main`) |
| **Bot source repo** | `PauliusOS/clonk-x-factory` (private/personal account) |
| **Generated app repos** | `clonkbot/<app-name>` (public, one repo per app) |
| **Generated app hosting** | Vercel, under the `clonkbot` Vercel account |
| **AI model** | Claude Sonnet 4 (`claude-sonnet-4-20250514`) via Anthropic SDK |
| **Runtime** | Node.js >= 22, TypeScript, Express |

### Project Structure

```
clonk-x-factory/
  src/
    index.ts              # Express server + polling loop
    pipeline.ts           # 4-step orchestrator
    services/
      claude.ts           # AI code generation via Anthropic SDK
      vercel.ts           # Vercel deployment via REST API
      github.ts           # GitHub repo creation + file upload
      xClient.ts          # OAuth 1.0a tweet replies
  dist/                   # Compiled JS output (generated by tsc)
  package.json
  tsconfig.json
```

## Pipeline Flow

The pipeline is defined in `src/pipeline.ts` and executes four steps sequentially. If any step fails, the bot attempts to reply with an error message so the user knows something went wrong.

### Step 1: Generate App (Claude)

The user's app idea (extracted from the tweet text) is sent to Claude Sonnet 4 with a detailed prompt. Claude returns a JSON object containing:

- `appName` -- a kebab-case project name
- `description` -- a one-sentence summary
- `files` -- an array of `{ path, content }` objects representing the full application

The generated app is always a client-side-only React 18 + TypeScript + Vite SPA with Tailwind CSS loaded via CDN. The prompt explicitly forbids `tsconfig.json` references to other config files, which would cause Vercel build failures.

### Step 2: Deploy to Vercel

The generated files are sent to the Vercel API v13 `/deployments` endpoint as plain text. Vercel runs `npm install` and `npm run build` (which executes `tsc && vite build`). The deployment URL is returned immediately, before the build finishes.

### Step 3: Create GitHub Repo

A new public repository is created under the `clonkbot` GitHub account. Each file is uploaded individually via the GitHub Contents API, resulting in one commit per file. Files are base64-encoded for the API.

### Step 4: Reply to Tweet

The bot replies to the original tweet using X API v2 with OAuth 1.0a authentication. The reply contains the live Vercel URL and the GitHub repo link.

## How to Use the Bot

**As an end user**, mention the bot on X:

```
@clonkbot build a pomodoro timer with dark mode
```

The bot will:
1. Detect the mention within its next polling cycle (up to 2 minutes)
2. Extract the idea: "a pomodoro timer with dark mode"
3. Generate, deploy, and publish the app
4. Reply with links to the live app and source code

**Requirements for a valid trigger:**
- The tweet must mention `@clonkbot`
- The tweet must contain the word "build" (case-insensitive)
- After stripping mentions and the "build" keyword, the remaining idea must be at least 3 characters

## Polling and Rate Limits

The bot polls the X API v2 mentions endpoint (`/2/users/:id/mentions`) every 2 minutes using a Bearer token.

**Why polling instead of webhooks?** The X Account Activity API (webhooks) requires the Pro plan at $5,000/month. Polling on the free tier is the only viable option.

**Free tier constraints:**
- Approximately 1 request per 15 minutes before hitting rate limits
- 100 posts pulled per month
- When rate-limited (HTTP 429), the bot silently retries on the next polling cycle

**Deduplication mechanisms:**
- `lastSeenTweetId`: Passed as `since_id` to only fetch tweets newer than the last seen one
- `startupTime`: Tweets created before the current server instance started are skipped, preventing reprocessing on redeploy
- `processingTweets` Set: Prevents the same tweet from being processed concurrently if it appears in consecutive polls

Note: `lastSeenTweetId` resets to empty on every deploy. The `startupTime` check is the primary safeguard against reprocessing old tweets.

## Error Handling

- **Pipeline failures**: The bot attempts to reply with a generic error message ("Sorry, I couldn't build that app right now. Please try again later!")
- **Redacted logging**: Axios errors are never logged in full because they contain Authorization headers. Only the HTTP status code and URL are logged.
- **Rate limit (429)**: Silently skipped; retried on the next poll cycle
- **Missing credentials**: Logged and skipped (the poll function returns early)

## Known Limitations

| Limitation | Impact |
|---|---|
| Free X tier: 100 posts/month | Hard cap on how many mentions can be read |
| `lastSeenTweetId` resets on deploy | Mitigated by `startupTime`, but a tweet arriving exactly during deploy could be missed |
| Sequential GitHub file uploads | One commit per file; slow for apps with many files |
| Vercel URL returned before build completes | The reply may contain a URL that is not yet live |
| No input sanitization | Prompt injection via tweet text is theoretically possible |
| `appName` used unsanitized in API URLs | Malformed names from Claude could cause API failures |
| No duplicate repo name handling | If Claude generates an `appName` that already exists under `clonkbot`, GitHub returns 422 |
| No persistent storage | Everything is in-memory; all state resets on deploy |

## Key Design Decisions

**"build" keyword requirement.** Random mentions and spam would otherwise burn Claude API credits and Vercel build minutes. Requiring an explicit trigger word keeps costs predictable.

**Self-contained tsconfig.json.** The Claude prompt explicitly forbids tsconfig references (`extends`, `references` pointing to `tsconfig.node.json`). Without this constraint, `vite init` templates include config references that break when the referenced files are missing, causing Vercel builds to fail.

**Background pipeline execution.** The `processTweetToApp` call is fire-and-forget (its Promise is not awaited in the polling loop). This ensures the polling loop continues on schedule even if generation and deployment take minutes.

**Brace-counting JSON extraction.** Instead of regex, the Claude service uses a brace-depth counter to find the outermost `{...}` in Claude's response. This handles nested objects and avoids regex pitfalls with multi-line JSON containing braces in string values.
