# Plan: Add Job Persistence Endpoints to clonk.ai Convex Backend

## Context

The clonk-x-factory server needs to persist web build jobs so they survive server restarts and users can revisit build URLs. The clonk.ai Convex backend (`tacit-capybara-732.convex.site`) already hosts the gallery — we add 2 new HTTP endpoints for job CRUD.

## Changes

### 1. Convex schema — add `jobs` table

```typescript
// In convex/schema.ts
jobs: defineTable({
  jobId: v.string(),        // UUID generated by factory server
  idea: v.string(),
  username: v.string(),
  status: v.string(),       // 'queued' | 'processing' | 'done' | 'error'
  stage: v.string(),        // 'classifying' | 'generating' | 'deploying' | 'screenshot' | 'publishing' | 'done'
  result: v.optional(v.string()),  // Final reply text with URLs (set when done)
  createdAt: v.number(),    // Unix timestamp ms
}).index("by_jobId", ["jobId"])
```

### 2. Convex internal mutation + query

```typescript
// convex/jobs.ts
import { mutation, query } from "./_generated/server";
import { v } from "convex/values";

export const upsert = mutation({
  args: {
    jobId: v.string(),
    idea: v.optional(v.string()),
    username: v.optional(v.string()),
    status: v.string(),
    stage: v.string(),
    result: v.optional(v.string()),
    createdAt: v.optional(v.number()),
  },
  handler: async (ctx, args) => {
    const existing = await ctx.db
      .query("jobs")
      .withIndex("by_jobId", (q) => q.eq("jobId", args.jobId))
      .unique();

    if (existing) {
      // Patch — only update provided fields
      const patch: Record<string, any> = { status: args.status, stage: args.stage };
      if (args.result !== undefined) patch.result = args.result;
      await ctx.db.patch(existing._id, patch);
    } else {
      // Insert — all fields required on create
      await ctx.db.insert("jobs", {
        jobId: args.jobId,
        idea: args.idea ?? "",
        username: args.username ?? "unknown",
        status: args.status,
        stage: args.stage,
        result: args.result,
        createdAt: args.createdAt ?? Date.now(),
      });
    }
  },
});

export const getByJobId = query({
  args: { jobId: v.string() },
  handler: async (ctx, args) => {
    return await ctx.db
      .query("jobs")
      .withIndex("by_jobId", (q) => q.eq("jobId", args.jobId))
      .unique();
  },
});
```

### 3. HTTP routes — add to `convex/http.ts`

Add two routes using the same auth pattern as `/api/publish`:

**`POST /api/job`** — create or update a job
- Auth: `Authorization: Bearer {API_KEY}` (same `CLONK_API_KEY` env var used by `/api/publish`)
- Content-Type: `application/json`
- Body: `{ jobId, idea?, username?, status, stage, result?, createdAt? }`
- Calls `api.jobs.upsert` internal mutation
- Returns `200 { ok: true }`

**`GET /api/job`** — fetch a job by ID
- Auth: same bearer key
- Query param: `?id=xxx`
- Calls `api.jobs.getByJobId` internal query
- Returns `200` with job object, or `404 { error: "Job not found" }`

```typescript
// In convex/http.ts — add these routes

http.route({
  path: "/api/job",
  method: "POST",
  handler: httpAction(async (ctx, request) => {
    // Auth check (same as /api/publish)
    const apiKey = process.env.CLONK_API_KEY;
    const auth = request.headers.get("Authorization");
    if (!auth || auth !== `Bearer ${apiKey}`) {
      return new Response(JSON.stringify({ error: "Unauthorized" }), { status: 401 });
    }

    const body = await request.json();
    await ctx.runMutation(api.jobs.upsert, body);
    return new Response(JSON.stringify({ ok: true }), {
      status: 200,
      headers: { "Content-Type": "application/json" },
    });
  }),
});

http.route({
  path: "/api/job",
  method: "GET",
  handler: httpAction(async (ctx, request) => {
    const apiKey = process.env.CLONK_API_KEY;
    const auth = request.headers.get("Authorization");
    if (!auth || auth !== `Bearer ${apiKey}`) {
      return new Response(JSON.stringify({ error: "Unauthorized" }), { status: 401 });
    }

    const url = new URL(request.url);
    const jobId = url.searchParams.get("id");
    if (!jobId) {
      return new Response(JSON.stringify({ error: "Missing id param" }), { status: 400 });
    }

    const job = await ctx.runQuery(api.jobs.getByJobId, { jobId });
    if (!job) {
      return new Response(JSON.stringify({ error: "Job not found" }), { status: 404 });
    }

    return new Response(JSON.stringify(job), {
      status: 200,
      headers: { "Content-Type": "application/json" },
    });
  }),
});
```

## Files to modify

| File | Action |
|---|---|
| `convex/schema.ts` | Add `jobs` table definition |
| `convex/jobs.ts` | New file — `upsert` mutation + `getByJobId` query |
| `convex/http.ts` | Add `POST /api/job` and `GET /api/job` routes |

## Verification

1. `npx convex deploy` succeeds
2. Test with curl:
   ```bash
   # Create job
   curl -X POST https://tacit-capybara-732.convex.site/api/job \
     -H "Authorization: Bearer $KEY" \
     -H "Content-Type: application/json" \
     -d '{"jobId":"test-123","idea":"test app","username":"dev","status":"processing","stage":"classifying","createdAt":1234567890}'

   # Fetch job
   curl "https://tacit-capybara-732.convex.site/api/job?id=test-123" \
     -H "Authorization: Bearer $KEY"
   ```
